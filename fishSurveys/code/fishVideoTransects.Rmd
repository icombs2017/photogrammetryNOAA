---
title: "Fish Video Transect Survey Analysis"
author: "Ian Combs -- icombs@mote.org"
date created: "01/13/2022"
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_doctument:
      toc: yes
      toc_depth: 3
---


```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
library(magrittr)
```

### version: `r Sys.Date() %>% format(format="%B %d, %Y")`
###
***
This is the analysis pipeline to analyze the community composition from fish video transects. Six experimental 10m x 10m plots were established in August 2020. Three more experimental 10m x 10m plots were established in June of 2021. Three transects of video were captured per site three times 1 month post-outplant and again, three more times 12 months post-outplant. Each transect was swam from the ledge to the hardpan, and 5 minutes elapsed between transects to allow for fish communities to return post diver disturbance. Still frames were pulled from each video every 3 seconds. Using the open source program **Ffmpeg**, the protocol for which can be found in the ../protocols folder within this repository. Fish were identified to the lowest taxonomic level possible, if applicable, the phase of the fish species was noted (terminal, initial, etc).

***

### All analyses performed with R version `r getRversion()`


# Basic setup of R environment
***
## Loading required packages
For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some may be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 

```{r,packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2","officer","ggpubr", "rcompanion", "RColorBrewer", "patchwork", "magrittr","reshape2", "stringr", "plyr", "dplyr", "flextable", "tidyr", "tibble", "vegan", "gdata")


```


# Loading data
***
Data generated from reviewing these videos and stills are stored in an excel spreadsheet found in the ../data folder. And loaded in using the `readxlsx()` from the package `readxl`. Note: we are also loading the `officer` package which has a similarly named function, so we are explicitly calling the `read_xlsx()` function from `readxl` using `::` notation.   


```{r, load and subset, include = TRUE, results = "hide"}

fish1 <- readxl::read_xlsx("../data/fishSurveyData.xlsx", sheet = 1, col_names = TRUE, na = c("", "N/A", "NA"))
fish1$date <- as.Date.factor(fish1$date)
fish1$site <- as.factor(fish1$site)
fish1$transect <- as.factor(fish1$transect)
fish1$frame <- as.factor(fish1$frame)
fish1$reviewer1SpeciesCm <- as.factor(fish1$reviewer1SpeciesCm)
fish1$reviewer1SpeciesGn <- as.factor(fish1$reviewer1SpeciesGn)
fish1$reviewer1SpeciesSc <- as.factor(fish1$reviewer1SpeciesSc)
fish1$reviewer1FullSciName <- as.factor(fish1$reviewer1FullSciName)
fish1$phase <- as.factor(fish1$phase)


fish <- fish1 %>% 
  select(date, site, reviewer1SpeciesCm,reviewer1SpeciesSc,reviewer1FullSciName, reviewer1Count) %>%
  filter(site == c("IC-C1", "IC-U1", "IC-Z1", "IC-C2", "IC-U2", "IC-Z2")) %>% 
  droplevels() %>% 
  group_by(date, site) %>% 
  add_count() %>% 
  ungroup() %>% 
  group_by(date, site, reviewer1FullSciName) %>% 
  summarise(count = sum(reviewer1Count), n = max(n), abundance = ((count/n)))

levels(fish$site)
                      
#filter(Date > "2015-09-04" & Date <"2015-09-18")
```

```{r}


# myColors <- paletteer_c("harrypotter::gryffindor", 6, direction = 1 )
#myColors <- paletteer_c("pals::ocean.balance", 6, direction = 1)
#Color Palette using a selection of Mote's preferred colors
myColors <- c("#d2232a", "#ca581f", "#f26522", "#85b034", "#00ae9d", "#78779e")

# Using this just to plot the top 2% of species
vpi1 <- vpi %>% 
  filter(abundance > 2) %>% 
  droplevels()
vpi1$class = factor(vpi1$class, levels(vpi1$class)[c(2,6,3,4,5,1)])




vpiStack1 <- ggplot(vpi1, aes(x = reef, y = abundance, fill = class, group = reef))+
                      geom_bar(stat = 'identity', color = 'black', position = position_stack(reverse = TRUE))+
                      ylim(0,100)+
                      labs(y = "Relative Abundance (%)", fill = "Class", title = "Relative Species Abundance > 2%")+
                      scale_fill_manual(values = myColors)+
                      facet_grid(treatment ~ time)

vpiStack <- vpiStack1+theme(
    axis.text.x = element_text(size = 40, colour = "black", vjust = 0.5, hjust = 0.5, face= "bold"), 
    axis.title.x = element_blank(),
    axis.title.y = element_text(size = 40, face = "bold"), 
    axis.text.y = element_text(colour = "black", size = 40, face = "bold"),
    legend.title = element_text(size = 40, face = "bold"), 
    legend.text = element_text(size = 36, face = "bold", colour = "black"), 
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
    panel.background = element_rect(fill = '#F5F5F5'), 
    plot.title = element_text(size = 40, face = "bold"), 
    axis.line = element_line(colour = "black"), 
    axis.ticks = element_line(color="black"), 
    text = element_text(size=40, color="black"), 
    legend.position = "bottom")
vpiStack









#subsetting for just one time point, and filtering outo anything lower than 2% abundance

fishPlot <- subset(fish, date < "2021-07-20")

fishPlot <- fish %>% 
  filter(date <"2021-07-20") %>%
  filter(abundance > 2) %>%
  droplevels()
levels(fishPlot$reviewer1FullSciName)


vpi1 <- vpi %>% 
  filter(abundance > 2) %>% 
  droplevels()
vpi1$class = factor(vpi1$class, levels(vpi1$class)[c(2,6,3,4,5,1)])



fishStack1 <- ggplot(fish, aes(x = site, y = abundance, fill = reviewer1FullSciName)) + 
    geom_bar(stat = "identity", colour = "black", position = position_stack(reverse = FALSE))+
    labs(y = "Relative Abundance (%)", fill = "Species", title = "Relative Species Abundance")+
    facet_wrap(date~. , scale = 'free')
    #scale_fill_manual(values = myColors)+
    #scale_x_discrete(name = "Site", limits = c("c1", "c2", "u1", "u2", "z1", "z2"), labels = c("C1", "C2", "U1", "U2", "Z1", "Z2"))
    
herbStack <- herbStack1+theme(
    axis.text.x = element_text(size = 40, colour = "black", vjust = 0.5, hjust = 0.5, face= "bold"), 
    axis.title.x = element_text(size = 40, color = "black", face = "bold"),
    axis.title.y = element_text(size = 40, face = "bold"), 
    axis.text.y = element_text(colour = "black", size = 40, face = "bold"),
    legend.title = element_text(size = 40, face = "bold"), 
    legend.text = element_text(size = 36, face = "bold", colour = "black"), 
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
    panel.background = element_rect(fill = '#F5F5F5'), 
    plot.title = element_text(size = 40, face = "bold"), 
    axis.line = element_line(colour = "black"), 
    axis.ticks = element_line(color="black"), 
    text = element_text(size=40, color="black"), 
    legend.position = "right")

herbStack





```




