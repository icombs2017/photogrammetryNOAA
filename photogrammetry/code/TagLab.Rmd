---
title: "TagLab"
author: "Ian Combs -- icombs@mote.org"
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_doctument:
      toc: yes
      toc_depth: 3
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
library(magrittr)
```

### version: `r Sys.Date() %>% format(format="%B %d, %Y")`

<!-- this is where the DOI would go  [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3675991.svg)](https://doi.org/10.5281/zenodo.3675991)
-->


#### [GitHub repository](https://github.com/icombs2017/photogrammetryNOAA.git){target="_blank"}

###
***
This is the analysis pipeline for data generated from TagLab annotations of our 6 10x10m plots.


***
### All analyses performe with R verion `r getRversion()`
# Basic setup of R environment
***
## Loading required packages

For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some must be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 

```{r, load packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2","officer","ggpubr", "rcompanion", "RColorBrewer", "patchwork", "magrittr","reshape2", "stringr", "plyr", "dplyr", "flextable", "tidyr", "tibble", "vegan")
```

<br><br>

# Loading Data

```{r, load data, include = TRUE, results = 'hide'}


tagC1Pre <- read.csv("../data/TagLab/2020_08_18_IC-C1.csv", header = T)
tagC1Post <- read.csv("../data/TagLab/2021_12_08_IC-C1.csv", header = T)
tagU1Pre <- read.csv("../data/TagLab/2020_08_19_IC-U1.csv", header = T)
tagU1Post <- read.csv("../data/TagLab/20201_12_08_IC-U1.csv", header = T)

```

<br><br>
# Manipulating data
***

We have loaded a lot of individual data into R and we want to combine the data and create one cohesive dataframe with which to work. In order to do that we have to add a few identifiers to our data frames to hwen combining we can differentiate between the two, but this is also a good time to add other columsn like **treatment** and **time** as well. The majority of this is done using various functions from the package `dplyr`. 

```{r}
sitec1 <- as.factor("c1")
sitec2 <- as.factor("c2")
siteu1 <- as.factor("u1")
siteu2 <- as.factor("u2")
sitez1 <- as.factor("z1")
sitez2 <- as.factor("z2")
pre <- as.factor("Baseline")
post <- as.factor("1 Year")


tagC1Pre <- read.csv("../data/TagLab/2020_08_18_IC-C1.csv", header = T)
tagC1Pre$TagLab.Class.name <- as.factor(tagC1Pre$TagLab.Class.name)
tagC1Pre$TagLab.Date <- as.Date.factor(tagC1Pre$TagLab.Date) 

tagC1Pre <- tagC1Pre %>% 
  select(TagLab.Date, TagLab.Class.name) %>% 
  add_column(sitec1) %>% 
  rename(site = sitec1) %>%
  add_column(pre) %>% 
  rename(time = pre) %>% 
  na.omit() %>%
  group_by(TagLab.Date, TagLab.Class.name, site, time) %>% 
  summarise(TagLab.Class.name, n()) %>% 
  rename(count = `n()`) %>% 
  distinct()
  tagC1Pre$abundance <- (tagC1Pre$count/sum(tagC1Pre$count)*100) 
 
tagC1Post <- read.csv("../data/TagLab/2021_12_08_IC-C1.csv", header = T)
tagC1Post$TagLab.Class.name <- as.factor(tagC1Post$TagLab.Class.name)
tagC1Post$TagLab.Date <- as.Date.factor(tagC1Post$TagLab.Date) 

tagC1Post <- tagC1Post %>% 
  select(TagLab.Date, TagLab.Class.name) %>% 
  add_column(sitec1) %>% 
  rename(site = sitec1) %>%
  add_column(post) %>% 
  rename(time = post) %>% 
  na.omit() %>%
  group_by(TagLab.Date, TagLab.Class.name) %>% 
  summarise(TagLab.Class.name, n()) %>% 
  rename(count = `n()`) %>%
  distinct()
tagC1Post$abundance <- (tagC1Post$count/sum(tagC1Post$count)*100) 



vpi$treatment = if_else(vpi$site %in% c("c2", "z1", "u1"), "Control","Outplanted") 
vpi$reef = if_else(vpi$site %in% c("c1", "c2"), "Site C",
                   if_else(vpi$site %in% c("u1", "u2"), "Site U", "Site Z"))
vpi$reef <- as.factor(vpi$reef)

myColors <- gg_color_hue(length(vpi$class))


```


```{r, load data, include = TRUE, results = 'hide'}
mydir <- "../data/TagLab/8.18.20"
tagLabFiles <- list.files(path = mydir, pattern = "_2020_", full.names = TRUE)
tagLabFiles


# This loads the list of .csv's that we made above and adds a column of file names to the data frame
tagLabFiles_list <- lapply(tagLabFiles, function(x){
  out <- tryCatch(read.csv(x, header = TRUE, sep = "\t"), error = function(e) NULL)
  if (!is.null(out)){
    out$source_file <- x
  }
  return(out)
})
tagLabData <- data.table::rbindlist(tagLabFiles_list)

# This takes the data, removes everything from the file name column except the important data to us, and sorts the data frame 
# so it contains only the information we care about 
tagLabData <- tagLabData %>% 
              separate(source_file, into = c("dir","source","program","date","file"), sep = "[/]", remove = FALSE) %>% 
              separate(file, c("assay", "file"), sep = "[.]") %>% 
              separate(assay, c("site", "status"), sep = "_") %>% 
  separate(site, c("status", "site"), sep = "-") %>%
  dplyr::select(site, Blob.id, Class.name, Coral.area)

tagLabData$Class.name <- as.factor(tagLabData$Class.name)

tagC1Pre <- tagLabData %>% filter(site == "C1")

tagC1Pre$speciesCount <- frequency(tagC1Pre$Class.name)





```

```{r, plotting, include = TRUE}

freqPlotData <- tagLabData

freqPlotData$speciesCount <- frequency(freqPlotData$Class.name)

freqPlotData1 <- freqPlotData %>% 
  dplyr::select(site, Class.name, speciesCount) %>% 
  group_by(site, Class.name) %>% 
  summarise(speciesCount = sum(speciesCount))



tagC1Pre$speciesCount <- frequency(tagC1Pre$Class.name)
tagC1Pre <- tagC1Pre %>% dplyr::select(site, Class.name, speciesCount) %>% 
  group_by(site, Class.name) %>% 
  summarise(speciesCount = sum(speciesCount))
tagC1Pre$Abundance <- tagC1Pre$speciesCount/sum(tagC1Pre$speciesCount)
tagC1Pre <- tagC1Pre %>% filter(Abundance > 0.01)


speciesFreq1 <- ggplot(freqPlotData1, aes(x = Class.name, y  = speciesCount, fill = site))+
                geom_bar(stat = 'identity', position = "stack")+
  coord_polar()

speciesFreq1


# freqPlotData2$Class.name <- factor(speciesFreq1$Class.name, levels = speciesFreq1$Class.name[order(-speciesFreq1$speciesCount)])



speciesBar1 <- ggplot(freqPlotData1, aes(x = reorder(Class.name, -speciesCount), y = speciesCount, fill = Class.name))+
  geom_bar(stat = 'identity')



speciesBar <- speciesBar1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'), 
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=20, color="black"), 
  axis.text.x=element_text(angle = 45, hjust = 1, size=14, color="black"), 
  axis.text.y=element_text(size=12, color="black")
)

speciesBar



c1PreSpeciesBar1 <- ggplot(tagC1Pre, aes(x = fct_reorder(Class.name, -speciesCount), y = Abundance, fill = Class.name))+
  geom_bar(stat = 'identity')+
  labs(x = "", y = "Percent Abundance", title = "Pre-Restoration")+
  scale_x_discrete(name = " ",limits=c("Siderastrea spp.","Stephannocoenia intersepta","Porites astreoides", "Orbicella faveolata"), labels =c("SSID","SINT","PAST", "OFAV"))+
  ylim(0,1)

c1PreSpeciesBar <- c1PreSpeciesBar1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'), 
  plot.title = element_text(), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=20, color="black"), 
  axis.text.x=element_text(angle = 45, hjust = 1, size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black")
)+rremove('legend')

c1PreSpeciesBar

ggsave("../figures/tagLabC1Pre.png", plot = c1PreSpeciesBar, width = 15, height = 10, units = "in", dpi = 600)

```





```{r}

mydir <- "../data/TagLab/12.14.20"
tagLabFiles <- list.files(path = mydir, pattern = "_2020_", full.names = TRUE)
tagLabFiles


# This loads the list of .csv's that we made above and adds a column of file names to the data frame
tagLabFiles_list <- lapply(tagLabFiles, function(x){
  out <- tryCatch(read.csv(x, header = TRUE, sep = "\t"), error = function(e) NULL)
  if (!is.null(out)){
    out$source_file <- x
  }
  return(out)
})
tagLabData <- data.table::rbindlist(tagLabFiles_list)

# This takes the data, removes everything from the file name column except the important data to us, and sorts the data frame 
# so it contains only the information we care about 
tagLabData <- tagLabData %>% 
              separate(source_file, into = c("dir","source","program","date","file"), sep = "[/]", remove = FALSE) %>% 
              separate(file, c("assay", "file"), sep = "[.]") %>% 
              separate(assay, c("site", "status"), sep = "_") %>% 
  separate(site, c("status", "site"), sep = "-") %>%
  dplyr::select(site, Blob.id, Class.name, Coral.area)

tagLabData$Class.name <- as.factor(tagLabData$Class.name)

tagC1Post <- tagLabData %>% filter(site == "C1")


tagC1Post$speciesCount <- frequency(tagC1Post$Class.name)
tagC1Post <- tagC1Post %>% dplyr::select(site, Class.name, speciesCount) %>% 
  group_by(site, Class.name) %>% 
  summarise(speciesCount = sum(speciesCount))
tagC1Post$Abundance <- tagC1Post$speciesCount/sum(tagC1Post$speciesCount)

tagC1Post <- tagC1Post %>% filter(Abundance > .01)

c1PostSpeciesBar1 <- ggplot(tagC1Post, aes(x = fct_reorder(Class.name, -speciesCount), y = Abundance, fill = Class.name))+
  geom_bar(stat = 'identity')+
  labs(y = "Percent Abundance", title = "Post-Restoration")+
  scale_x_discrete(name = "Class",limits=c("Acropora cervicornis", "Siderastrea spp.","Orbicella faveolata","Stephannocoenia intersepta","Porites astreoides"), labels =c("ACER","SSID","OFAV","SINT","PAST"))+
  ylim(0,1)

c1PostSpeciesBar <- c1PostSpeciesBar1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'), 
  plot.title = element_text(), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=20, color="black"), 
  axis.text.x=element_text(angle = 45, hjust = 1, size=14, color="black"), 
  axis.text.y=element_text(size=12, color="black")
)+rremove('legend')

c1PostSpeciesBar


compBar <- c1PreSpeciesBar / c1PostSpeciesBar + plot_annotation(
  title = 'Coral Community Composition Pre- and Post- Restoration using TagLab',
  theme = theme(plot.title = element_text(size = 30)))


plot_annotation(
  title = 'Benthic Community Composition Pre- and Post- Restoration using Virtual Point Intercept',
  theme = theme(plot.title = element_text(size = 30)))




ggsave("../figures/tagLabComp.png", plot = compBar, width = 15, height = 10, units = "in", dpi = 600)



```

```{r}
```

