---
title: "Analysis of Herbivory Assay: Herbivore Community Composition"
author: "Ian Combs -- icombs@mote.org"
date created: "07/30/2021"
last modified: "01/08/2022"
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_doctument:
      toc: yes
      toc_depth: 3
---
```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
library(magrittr)
```

### version: `r Sys.Date() %>% format(format="%B %d, %Y")`
###
***
This is the analysis pipeline to analyze the community composition of herbivores predating upon the herbivory assays. Six experimental 10m x 10m plots were established in Year 1 and 3 additional experimental plots were estabished in Y2. Two herbivory assays were deployed at each site. Each assay consisted for 5 blades of **Thalassia testudinum** set in clothespins threaded onto galvanized wire at 6in. intervals. The assays were deployed for 2 hours and filmed using a GoPro camera. The videos were analyzed to determine which species of herbivorous fish were predating upon the herbivory assays. Only fish that actually ate seagrass were noted, the blades that were predated upon were noted to the best of the reviewers ability, and, if applicable, the phase of the herbivore was noted (terminal, initial, etc).


***

### All analyses performed with R version `r getRversion()`


# Basic setup of R environment
***
## Loading required packages
For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some must be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 

```{r,packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2","officer","ggpubr", "rcompanion", "RColorBrewer", "patchwork", "magrittr","reshape2", "stringr", "plyr", "dplyr", "flextable", "tidyr", "tibble", "vegan", "gdata", "readxl", "EnvStats", "emmeans", "MuMIn", "sjstats", "lmerTest", "gnm", "forcats")
pacman::p_load_gh("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")



```



# Loading data
***
Data generated from reviewing these videos are stored in an excel spreadsheet found in the ../data folder. And loaded in using the `read.xls()` from the package `gdata`.  

```{r, load and subset, include = TRUE, results = "hide"}
herb1 <-read_excel("../data/herbivoryVideoDataSheet.xlsx", sheet = 1)
herb1$date <- as.Date.factor(herb1$date)
herb1$site <- as.factor(herb1$site)
herb1$assay <- as.factor(herb1$assay)
herb1$reviewer1SpeciesCm <- as.factor(herb1$reviewer1SpeciesCm)
herb1$reviewer1SpeciesGn <- as.factor(herb1$reviewer1SpeciesGn)
herb1$reviewer1SpeciesSc <- as.factor(herb1$reviewer1SpeciesSc)
herb1$reviewer1FullSciName <- as.factor(herb1$reviewer1FullSciName)
herb1$species <- herb1$reviewer1FullSciName



herb <- herb1 %>% select(date, site, species, reviewer1Count, reviewer1Blade) %>%
group_by(date, site) %>% 
  add_count() %>% 
  ungroup() %>% 
  group_by(date, site, species) %>% 
  summarise(count = sum(reviewer1Count), n = max(n), abundance = ((count/n)))


```

<br><br>

# Normality Tests
***
Here we are exploring the distribution of the data, if the data is not normally distributed we will try to transform the data to meet a normal distribution.  

```{r, normalityTest, include = TRUE}

#Testing normality of abundance and count
hist(herb$abundance)
shapiro.test(herb$abundance)

hist(herb$count)
shapiro.test(herb$count)

# Trying an arcsine transformation on the proportional abundance data

hist(asin(sqrt(herb$abundance)))
shapiro.test(asin(sqrt(herb$abundance)))

# Trying a square root transformation on the count data

hist(sqrt(herb$count+1/2))
shapiro.test(sqrt(herb$count+1/2))

# Trying a square transformation on the count data

hist((herb$count)^2)
shapiro.test((herb$count)^2)

# Trying a square transformation on the count data

hist(exp(herb$count))
shapiro.test(exp(herb$count))

# Trying a reciprocal transformation on the count data

hist(1/(herb$count))
shapiro.test(1/(herb$count))


```
# Split Data
***
Here we are going to split the data between Y1 and Y2 sites. 

```{r, splitData, include = TRUE}
herbY1 <- herb %>% 
  dplyr::select(date, site, species, count, n, abundance) %>% 
  dplyr::filter(site %in% c("IC-C1", "IC-C2", "IC-U1", "IC-U2", "IC-Z1", "IC-Z2"))

herbY1$treatment <- if_else(herbY1$site %in% c("IC-C2", "IC-U1", "IC-Z1"), "Control", "Outplanted")
year1 <- "Y1"
herbY1$year <- year1


herbY1$timePoint= if_else(herbY1$date <= ("2020-10-15"), "T0",
                       if_else(herbY1$date > ("2020-10-15") & herbY1$date <= ("2021-06-15"), "T6",
                       if_else(herbY1$date > ("2021-06-15") & herbY1$date <= ("2022-01-28"), "T12", "T18")))
herbY1$treatment <- as.factor(herbY1$treatment)
herbY1$year <- as.factor(herbY1$year)
herbY1$timePoint <- as.factor(herbY1$timePoint)
levels(herbY1$timePoint)
herbY1$timePoint = factor(herbY1$timePoint, levels(herbY1$timePoint)[c(1, 4, 2, 3)])
levels(herbY1$timePoint)


#Doing the same for Y2 Note: the controls are the same throughout 

herbY2 <- herb %>% 
  dplyr::select(date, site, species, count, n, abundance) %>% 
  dplyr::filter(site %in% c("IC-C2", "IC-U1", "IC-Z1", "IC-C3", "IC-Z3", "IC-U3")) %>% 
  dplyr::filter(date > "2020-10-15")

herbY2$treatment <- if_else(herbY2$site %in% c("IC-C2", "IC-U1", "IC-Z1"), "Control", "Outplanted")
year2 <- "Y2"
herbY2$year <- year2

herbY2$timePoint= if_else(herbY2$date <= ("2021-06-15"), "T0",
                       if_else(herbY2$date > ("2021-06-15") & herbY2$date <= ("2022-01-28"), "T6", "T12"))

herbY2$treatment <- as.factor(herbY2$treatment)
herbY2$year <- as.factor(herbY2$year)
herbY2$timePoint <- as.factor(herbY2$timePoint)
levels(herbY2$timePoint)
herbY2$timePoint = factor(herbY2$timePoint, levels(herbY2$timePoint)[c(1, 3, 2)])




herbTotal <- bind_rows(herbY1, herbY2)



```



# Linear Model 
***
Here we are going to build a linear model which we'll use to analyze the data. 

```{r, linearModel, include = TRUE}

set.seed(999)
adonis2(formula = herbY1$abundance ~ treatment*species + timePoint + site, data = herbY1, method = "euclidian", permutations = 9999)

pairwise.adonis2(herbY1[6]~species,data=herbY1)
pairwise.adonis(herbY1[6],factors=herbY1$species,
                             sim.method='euclidian',p.adjust.m='bonferroni', perm = 999)


set.seed(999)
adonis2(formula = herbY2$abundance ~ treatment*species + timePoint + site, data = herbY2, method = "euclidian", permutations = 9999)

pairwise.adonis(herbY2[6],factors=herbY2$species,
                             sim.method='euclidian',p.adjust.m='bonferroni', perm = 999)


set.seed(999)
herbPerm <- adonis2(formula = herbTotal$abundance ~ treatment + species + timePoint + year + site, data = herbTotal, method = "euclidian", permutations = 9999)



```


# PERMANOVA Table
***

Here we are using the package `officer` to create a publication ready table for our PERMANOVA results. 
```{r, PERMANOVAtable, include = TRUE}

herbPerm <- tibble::rownames_to_column(herbPerm)


herbPermTab <- herbPerm %>% 
  dplyr::rename("Factor" = "rowname") %>% 
  dplyr::rename("Degrees of Freedom" = "Df") %>% 
  dplyr::rename("Sum of Squares" = "SumOfSqs") %>% 
  dplyr::rename("Pseudo.F" = "F") %>% 
  dplyr::rename( "p.value"  = "Pr(>F)") %>%

mutate_if(is.numeric, round, digits = 3) %>%     
mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>% 
mutate_if(is.character, str_replace_all, pattern = "-", replacement = "â€“") %>%
flextable() %>%
set_header_labels(Data.set = "Data set") %>% 
flextable::compose(part = "header", j = "Degrees of Freedom", value = as_paragraph("Degrees of Freedom")) %>% 
flextable::compose(part = "header", j = "Pseudo.F", value = as_paragraph("Pseudo-F")) %>%
flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
autofit() %>%
font(fontname = "Times New Roman", part = "all") %>%
fontsize(size = 12, part = "all") %>%
bold(part = "header") %>%
colformat_num(j = 'Degrees of Freedom', digits = 2) %>% 
colformat_num(j = "Pseudo.F", digits = 2) %>%
colformat_num(j = "p.value", digits = 4, na_str = "ns") %>% 
align_nottext_col(align = "center", header = TRUE, footer = TRUE) %>% 
align(align = "center", j = "p.value")

herbDoc = read_docx()
herbDoc = body_add_flextable(herbDoc, value = herbPermTab)
print(herbDoc, target = "../tables/herbivoryTable.docx")
herbPermTab






```


# Plotting the data
***

To visualize the data and what our species composition looks like at our sites, we are going to plot the data in a few different ways.



```{r, graph, include = TRUE}

myColors <- c("#006BFF", "#277B00", "#ff0000", "#97DE00", "#00ffff", "#6495ed" , '#843BFF', "#ffd700", "#BF5B9A", "#003E94", "#FF9200", "#60f542", '#F96D67', '#9067F9', '#F967C1')

# 
# levels(herbY2$species) <- levels(herbTotal$species)
# levels(herbY1$species) <- levels(herbTotal$species)
#subsetting for just one time point

# herbivoryPlot <- subset(fish, date == c("2020-10-14", "2020-10-15"))

# herbY1$species<- fct_reorder(herbY1$species, herbY1$abundance, .desc = FALSE)
# herbY2$species<- fct_reorder(herbY2$species, herbY2$abundance, .desc = FALSE)

y1HerbStack1 <- ggplot(herbY1, aes(x = site, y = abundance, fill = fct_reorder(species, abundance))) + 
    geom_bar(stat = "identity", colour = "black", position = position_stack(reverse = FALSE))+
    labs(y = "Relative Abundance (%)", x = "Site", fill = "Species", title = "Relative Species Abundance")+
scale_fill_manual(values=myColors)+
    facet_wrap(~timePoint)
    
y1HerbStack <- y1HerbStack1+theme(
    axis.text.x = element_text(size = 20, colour = "black", angle = 45, vjust = 0.5, hjust = 0.5, face= "bold"), 
    axis.title.x = element_text(size = 40, color = "black", face = "bold"),
    axis.title.y = element_text(size = 40, face = "bold"), 
    axis.text.y = element_text(colour = "black", size = 20, face = "bold"),
    legend.title = element_text(size = 40, face = "bold"), 
    legend.text = element_text(size = 30, face = "bold", colour = "black"), 
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
    panel.background = element_rect(fill = '#F5F5F5'), 
    plot.title = element_text(size = 40, face = "bold"), 
    axis.line = element_line(colour = "black"), 
    axis.ticks = element_line(color="black"), 
    text = element_text(size=40, color="black"), 
    legend.position = "right")

y1HerbStack
ggsave("../figures/year1HerbivoryPlot.png", plot = y1HerbStack, width = 30, height = 15, units = "in", dpi = 600)


y2HerbStack1 <- ggplot(herbY2, aes(x = site, y = abundance, fill = fct_reorder(species, abundance))) + 
    geom_bar(stat = "identity", colour = "black", position = position_stack(reverse = FALSE))+
    #ylim(0,100) + 
    labs(y = "Relative Abundance (%)", x = "Site", fill = "Species", title = "Relative Species Abundance")+
  scale_fill_manual(values=myColors)+
    facet_wrap(~timePoint)
    
y2HerbStack <- y2HerbStack1+theme(
    axis.text.x = element_text(size = 20, colour = "black", angle = 45, vjust = 0.5, hjust = 0.5, face= "bold"), 
    axis.title.x = element_text(size = 40, color = "black", face = "bold"),
    axis.title.y = element_text(size = 40, face = "bold"), 
    axis.text.y = element_text(colour = "black", size = 20, face = "bold"),
    legend.title = element_text(size = 40, face = "bold"), 
    legend.text = element_text(size = 30, face = "bold", colour = "black"), 
    panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
    panel.background = element_rect(fill = '#F5F5F5'), 
    plot.title = element_text(size = 40, face = "bold"), 
    axis.line = element_line(colour = "black"), 
    axis.ticks = element_line(color="black"), 
    text = element_text(size=40, color="black"), 
    legend.position = "right")

y2HerbStack


#Not Sure if I want to try and combine plots using patchwork for Y1 and Y2 sites.

#stackCombo <- y1HerbStack + y2HerbStack



ggsave("../figures/year2HerbivoryPlot.png", plot = y2HerbStack, width = 20, height = 15, units = "in", dpi = 600)



```














